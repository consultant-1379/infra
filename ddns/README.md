cloud_ddns
==========

Setup a to create a dynamic DNS for instances in an OpenStack cloud
This is just has some small veraitions from this project to make it work with mitaka.
https://github.com/douglin/cloud_ddns

==========

SUMMARY of DDNS scripts
-----------------------

These scripts 
This solution includes the following:

1.  setup file - setup_ddns.sh

2.  configuration file - ddns_config.yaml

3.  ddns.sh executable - this main script will be autogenerated by setup_ddns.sh

4.  python routines that are executed by scripts: ddns.py, gen_bind_files.py, gen_ddns_sh.py and ddns_common.py

5.  templates directory, including templates for generating the following: ddns.sh, named.conf, forward and reverse zone files

PRE-REQUISITES
--------------

1.  Deploy a Centos/RHEL 6.5 instance for the DNS. It should be sufficient to choose a smaller flavor like “n1.small”.

2.  Add a Floating IP

3.  Setup security group rules for the DNS instance. The following ports should be open: TCP 22 (SSH), TCP 53 and UDP 53 (for DNS).

4.  If the iptables service is on, it may be easiest to turn it off

5.  Ensure that the OpenStack CLI clients are installed 


PART 1 - HOW TO INSTALL
-----------------------

### 1. Install BIND

Install the bind and bind-utils packages if they have not already been installed.

    [centos@ddns ~]$ sudo yum update -y
    [centos@ddns ~]$ sudo yum install -y bind bind-utils

### 2. Get the Cloud Admin’s OpenStack API Credentials, e.g. openrc.sh

Using the Admin’s credentials will allow the “DDNS “ scripts to see instances across projects. 
If openrc.sh prompts for a password, remove the prompt and add the password in the file. Including the password in the file will be required for the scripts to run automatically. 

Below is an example of how to test the openrc.sh file using the OpenStack CLI.

    [centos@ddns ~]$ source openrc.sh 
    [centos@ddns ~]$ nova list

### 3. GT Pull scripts for the DDNS 


    [centos@ddns ~]$ git clone ssh://lmistky@gerrit-gamma.gic.ericsson.se:29418/AIA/CI/infra && cd infra/ddns
     
### 4. Setup ddns_config.yaml

The “ddns_config.yaml” file has all of the configuration parameters that will be used to configure BIND and the “DDNS” scripts. Edit this file and input customized information. Then save the file.  It is important to make sure there are no errors, like no overlapping IP ranges in this file. Note that all fields can take only one value with the exception of “forwarders” and “ip_ranges”. Multiple forwarders and IP address ranges can be included. The IP address ranges are for both the fixed and floating OpenStack networks. These scripts require that the ranges be on octet boundaries, e.g. /24, /16 or /8.
Here is an already filled in sample of the required fields.

    
    domain_name: gtcl1a.acme.com
    dns_shortname: cloudns
    dns_fixed_ip: 192.168.111.27
    dns_floating_ip: 131.160.133.48
    forwarders:
      - 159.107.189.59
    ip_ranges:
      - 131.160.133.0/24 
      - 192.168.111.0/24   
      - 192.168.22.0/24    
  - 10.88.88.0/24  

### 5. Run setup_ddns.sh to complete the DNS setup

setup_ddns.sh creates configuration files for the DNS updates as well as configuration files for BIND. It then moves the BIND files to the appropriate directories and restarts the DNS (“named”) service.  Feel free to view the script to see what it does. Run this script using “sudo”. 

    [centos@ddns ~]$ sudo ./setup_ddns.sh

### 6. Run ddns.sh to complete the setup of the Dynamic DNS

Now the main executable script, ddns.sh, has been created. It will use the OpenStack APIs to query instances and then update the DNS appropriately. Run the script.

    [centos@ddns ~]$ ./ddns.sh

### 7. Run ddns.sh in loop

The following scripts runs ddns to update the DNS with openstack instances every 20 seconds.

    [centos@ddns ~]$ ./loop-ddns.sh &


###8. Test the DNS Server

Use ping and dig or nslookup to test the DNS server

PART 2 - CIONFIGURE INSTANCES FOR NEW DNS
---------------------------------

You can manually configure resolv.conf or edit the openstack sebnet to populate DNS via DHCP.
<br>
To test you can nslookup on instance for its local IP.<br>
In this setup the instance hostname will resolve to local IP and not floating IP. <br>
To change this bevahiour so that the ddns will resolve to floating IP change line 135 in ddns.py<br>
From:<br>
for ip in ip_addresses[-1] <br>
<br>
To:
for ip in ip_addresses[0] <br>
